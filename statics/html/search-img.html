<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片搜索</title>
    <link rel="stylesheet" href="../css/searchimg.css">
</head>

<body>
    <div class="container">
        <h1>图片搜索</h1>
        <form id="searchForm">
            <input type="text" id="imageName" placeholder="输入图片名称">
            <div class="button-group">
                <button type="submit" id="searchButton">搜索</button>
                <button type="button" id="allImagesButton">获取所有图片</button>
            </div>
        </form>
        <div id="resultArea"></div>
    </div>

    <script>
        function isMobile() {
            return window.innerWidth <= 768;
        }

        function displayResults(responseData) {
            const resultArea = document.getElementById('resultArea');
            console.log('Response data:', responseData); // 调试日志

            if (responseData.data && Array.isArray(responseData.data) && responseData.data.length > 0) {
                if (isMobile()) {
                    const tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>图片名称</th>
                                <th>上传时间</th>
                                <th>标签</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${responseData.data.map(image => {
                        console.log('处理的图片数据:', image); // 调试日志
                        return `
                                <tr>
                                    <td><a href="${image.image_url || ''}" target="_blank">${image.image_name || ''}</a></td>
                                    <td>${image.UploadTime ? new Date(image.UploadTime).toLocaleString() : ''}</td>
                                    <td>${Array.isArray(image.Tags) && image.Tags.length > 0 ?
                                image.Tags.map(tag => `<span class="tag">${tag.TagName}</span>`).join(' ')
                                : '无标签'}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                    `;
                    resultArea.innerHTML = tableHTML;
                } else {
                    const tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>图片ID</th>
                                <th>图片名称</th>
                                <th>哈希</th>
                                <th>大小</th>
                                <th>类型</th>
                                <th>上传时间</th>
                                <th>描述</th>
                                <th>标签</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${responseData.data.map(image => {
                        console.log('处理的图片数据:', image); // 调试日志
                        return `
                                <tr>
                                    <td>${image.id || ''}</td>
                                    <td><a href="${image.image_url || ''}" target="_blank">${image.image_name || ''}</a></td>
                                    <td>${image.hash_image || ''}</td>
                                    <td>${image.image_size || ''}</td>
                                    <td>${image.image_type || ''}</td>
                                    <td>${image.UploadTime ? new Date(image.UploadTime).toLocaleString() : ''}</td>
                                    <td>${image.description || ''}</td>
                                    <td>${Array.isArray(image.Tags) && image.Tags.length > 0 ?
                                image.Tags.map(tag => `<span class="tag">${tag.TagName}</span>`).join(' ')
                                : '无标签'}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                    `;
                    resultArea.innerHTML = tableHTML;
                }
            } else {
                resultArea.textContent = '没有找到匹配的图片。';
            }
        }

        async function fetchImages(isAllImages) {
            const token = localStorage.getItem('token');
            const url = isAllImages ? 'http://127.0.0.1:8080/searchAllimg' : 'http://127.0.0.1:8080/searchimg';
            const payload = isAllImages ? { allimg: true } : { name: document.getElementById('imageName').value };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                displayResults(responseData);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('resultArea').textContent = '搜索过程中发生错误，请稍后再试。';
            }
        }

        document.getElementById('searchForm').addEventListener('submit', function (e) {
            e.preventDefault();
            fetchImages(false);
        });

        document.getElementById('allImagesButton').addEventListener('click', function () {
            fetchImages(true);
        });

        // 监听窗口大小变化，重新渲染结果
        window.addEventListener('resize', function () {
            const resultArea = document.getElementById('resultArea');
            if (resultArea.innerHTML !== '') {
                // 如果当前有显示结果，重新获取数据并渲染
                if (document.getElementById('imageName').value) {
                    fetchImages(false);
                } else {
                    fetchImages(true);
                }
            }
        });
    </script>
</body>

</html>